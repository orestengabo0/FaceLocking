#!/usr/bin/env python\n\"\"\"\nQuick Start Script for Face Recognition & Locked Face Tracking System\n\nThis script walks you through the setup and provides shortcuts for common tasks.\n\nUsage:\n    python quickstart.py\n\"\"\"\n\nimport sys\nimport subprocess\nfrom pathlib import Path\n\n\ndef print_header(text):\n    \"\"\"Print formatted header.\"\"\"\n    print(\"\\n\" + \"=\" * 60)\n    print(f\"  {text}\")\n    print(\"=\" * 60)\n\n\ndef print_section(text):\n    \"\"\"Print formatted section.\"\"\"\n    print(f\"\\n>>> {text}\")\n\n\ndef run_command(cmd, description):\n    \"\"\"Run a command and report result.\"\"\"\n    print_section(description)\n    print(f\"Running: {' '.join(cmd)}\")\n    try:\n        result = subprocess.run(cmd, check=True, capture_output=False)\n        print(f\"✓ {description} completed successfully\")\n        return True\n    except subprocess.CalledProcessError as e:\n        print(f\"✗ Error: {e}\")\n        return False\n    except FileNotFoundError:\n        print(f\"✗ Command not found. Make sure it's installed and in PATH.\")\n        return False\n\n\ndef check_dependencies():\n    \"\"\"Check if required Python packages are installed.\"\"\"\n    print_section(\"Checking Python dependencies\")\n    \n    required = {\n        'cv2': 'opencv-python',\n        'numpy': 'numpy',\n        'onnxruntime': 'onnxruntime',\n        'scipy': 'scipy',\n        'mediapipe': 'mediapipe',\n        'mqtt': 'paho-mqtt',\n    }\n    \n    missing = []\n    for module, package in required.items():\n        try:\n            __import__(module)\n            print(f\"  ✓ {package}\")\n        except ImportError:\n            print(f\"  ✗ {package} (missing)\")\n            missing.append(package)\n    \n    if missing:\n        print(\"\\nInstalling missing packages...\")\n        cmd = [sys.executable, \"-m\", \"pip\", \"install\"] + missing\n        return run_command(cmd, \"Install dependencies\")\n    else:\n        print(\"\\n✓ All dependencies installed!\")\n        return True\n\n\ndef check_mqtt_broker():\n    \"\"\"Check if MQTT broker is accessible.\"\"\"\n    print_section(\"Checking MQTT broker\")\n    \n    try:\n        import paho.mqtt.client as mqtt\n        \n        client = mqtt.Client()\n        print(\"  Connecting to localhost:1883...\")\n        \n        try:\n            client.connect(\"localhost\", 1883, 5)\n            print(\"  ✓ MQTT broker is running!\")\n            client.disconnect()\n            return True\n        except:\n            print(\"  ✗ MQTT broker not responding\")\n            print(\"\\n  Start MQTT broker:\")\n            print(\"    Windows:  mosquitto -v\")\n            print(\"    Linux:    sudo systemctl start mosquitto\")\n            print(\"    macOS:    brew services start mosquitto\")\n            return False\n    except ImportError:\n        print(\"  ✗ paho-mqtt not installed\")\n        return False\n\n\ndef check_camera():\n    \"\"\"Check if USB camera is available.\"\"\"\n    print_section(\"Checking camera availability\")\n    \n    try:\n        import cv2\n        \n        found = False\n        for i in range(5):\n            cap = cv2.VideoCapture(i)\n            if cap.isOpened():\n                width = int(cap.get(cv2.CAP_PROP_FRAME_WIDTH))\n                height = int(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))\n                print(f\"  ✓ Camera {i}: {width}x{height}\")\n                cap.release()\n                found = True\n        \n        if found:\n            print(\"  Update camera_index in config if using different camera\")\n            return True\n        else:\n            print(\"  ✗ No camera detected\")\n            return False\n    except ImportError:\n        print(\"  ✗ OpenCV not installed\")\n        return False\n\n\ndef check_database():\n    \"\"\"Check if face database exists.\"\"\"\n    print_section(\"Checking face database\")\n    \n    db_path = Path(\"data/db/face_db.npz\")\n    if db_path.exists():\n        print(f\"  ✓ Database found: {db_path}\")\n        return True\n    else:\n        print(f\"  ✗ Database not found: {db_path}\")\n        print(\"\\n  You need to enroll faces first!\")\n        return False\n\n\ndef menu():\n    \"\"\"Main menu.\"\"\"\n    print_header(\"Face Recognition & Locked Face Tracking System\")\n    \n    options = [\n        (\"Run system checks\", run_checks),\n        (\"Install dependencies\", lambda: run_command(\n            [sys.executable, \"-m\", \"pip\", \"install\", \"-r\", \"requirements.txt\"],\n            \"Install dependencies\"\n        )),\n        (\"Enroll new person\", lambda: run_command(\n            [sys.executable, \"-m\", \"src.enroll\"],\n            \"Face enrollment\"\n        )),\n        (\"Start MQTT broker (manual)\", lambda: print(\"Please start MQTT broker separately:\" and None)),\n        (\"Run integrated system\", lambda: run_command(\n            [sys.executable, \"-m\", \"src.integrated_system\"],\n            \"Start integrated system\"\n        )),\n        (\"Monitor MQTT messages\", lambda: run_command(\n            [\"mosquitto_sub\", \"-v\", \"-h\", \"localhost\", \"-t\", \"#\"],\n            \"Monitor MQTT\"\n        )),\n        (\"View documentation\", show_docs),\n        (\"Exit\", lambda: None),\n    ]\n    \n    while True:\n        print(\"\\nSelect an option:\")\n        for i, (description, _) in enumerate(options, 1):\n            print(f\"  {i}. {description}\")\n        \n        try:\n            choice = int(input(\"\\nEnter your choice (1-{}): \".format(len(options))))\n            if 1 <= choice <= len(options):\n                _, action = options[choice - 1]\n                if choice == len(options):  # Exit\n                    print(\"\\nGoodbye!\")\n                    break\n                action()\n            else:\n                print(\"Invalid choice\")\n        except (ValueError, EOFError):\n            print(\"Invalid input\")\n        except KeyboardInterrupt:\n            print(\"\\n\\nInterrupted by user\")\n            break\n\n\ndef run_checks():\n    \"\"\"Run all system checks.\"\"\"\n    print_header(\"System Health Check\")\n    \n    results = []\n    \n    results.append((\"Dependencies\", check_dependencies()))\n    results.append((\"Camera\", check_camera()))\n    results.append((\"MQTT Broker\", check_mqtt_broker()))\n    results.append((\"Face Database\", check_database()))\n    \n    print(\"\\n\" + \"=\" * 60)\n    print(\"Checks Summary:\")\n    print(\"=\" * 60)\n    \n    for name, passed in results:\n        status = \"✓ PASS\" if passed else \"✗ FAIL\"\n        print(f\"{name:20} {status}\")\n    \n    all_passed = all(passed for _, passed in results)\n    \n    if all_passed:\n        print(\"\\n✓ All checks passed! Ready to run the system.\")\n        print(\"\\nNext: Select 'Run integrated system' from menu\")\n    else:\n        print(\"\\n✗ Some checks failed. Please resolve the issues above.\")\n    \n    return all_passed\n\n\ndef show_docs():\n    \"\"\"Show documentation menu.\"\"\"\n    print_header(\"Documentation\")\n    \n    docs = [\n        (\"README_COMPLETE_SYSTEM.md\", \"System overview and architecture\"),\n        (\"SETUP.md\", \"Installation and configuration guide\"),\n        (\"USAGE_GUIDE.md\", \"System usage and operations\"),\n        (\"MQTT_PROTOCOL.md\", \"MQTT message specification\"),\n    ]\n    \n    print(\"\\nAvailable documentation:\")\n    for filename, description in docs:\n        path = Path(filename)\n        if path.exists():\n            print(f\"  ✓ {filename:30} - {description}\")\n        else:\n            print(f\"  ✗ {filename:30} - (not found)\")\n    \n    print(\"\\nOpen these files with your text editor or IDE for detailed information.\")\n\n\ndef quick_test():\n    \"\"\"Run a quick test of the system.\"\"\"\n    print_header(\"Quick System Test\")\n    \n    # Test imports\n    print_section(\"Testing imports\")\n    try:\n        from src.recognize import HaarFaceMesh5pt, ArcFaceEmbedderONNX\n        print(\"  ✓ Core modules imported successfully\")\n    except ImportError as e:\n        print(f\"  ✗ Import error: {e}\")\n        return False\n    \n    # Test MQTT\n    print_section(\"Testing MQTT\")\n    try:\n        from mqtt_handler import MQTTManager\n        mqtt = MQTTManager()\n        if mqtt.connect():\n            print(\"  ✓ MQTT connection successful\")\n            mqtt.disconnect()\n        else:\n            print(\"  ✗ MQTT connection failed\")\n            return False\n    except Exception as e:\n        print(f\"  ✗ MQTT error: {e}\")\n        return False\n    \n    # Test servo controller\n    print_section(\"Testing servo controller\")\n    try:\n        from servo_controller import ServoController\n        from mqtt_handler import MQTTManager\n        mqtt = MQTTManager()\n        servo = ServoController(mqtt)\n        print(f\"  ✓ Servo controller initialized\")\n        print(f\"    Center angle: {servo.center_angle}°\")\n        print(f\"    Range: {servo.min_angle}° - {servo.max_angle}°\")\n    except Exception as e:\n        print(f\"  ✗ Servo error: {e}\")\n        return False\n    \n    print(\"\\n✓ Quick test completed successfully!\")\n    return True\n\n\nif __name__ == \"__main__\":\n    try:\n        # Check if running in interactive mode\n        if len(sys.argv) > 1:\n            if sys.argv[1] == \"check\":\n                run_checks()\n            elif sys.argv[1] == \"test\":\n                quick_test()\n            elif sys.argv[1] == \"docs\":\n                show_docs()\n            else:\n                print(f\"Unknown command: {sys.argv[1]}\")\n                print(\"\\nUsage:\")\n                print(\"  python quickstart.py          - Interactive menu\")\n                print(\"  python quickstart.py check    - Run system checks\")\n                print(\"  python quickstart.py test     - Run quick test\")\n                print(\"  python quickstart.py docs     - Show documentation\")\n        else:\n            # Interactive menu\n            menu()\n    except KeyboardInterrupt:\n        print(\"\\n\\nQuickstart interrupted by user\")\n        sys.exit(0)\n