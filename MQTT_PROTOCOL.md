# MQTT Protocol Specification\n\n## Overview\n\nThe Face Recognition & Locked Face Tracking system uses MQTT (Message Queuing Telemetry Transport) for communication between the PC-based vision module and the ESP8266 microcontroller managing the servo motor.\n\n## MQTT Broker Configuration\n\n### Topics Hierarchy\n\n```\nface/\n├── actions/        # Face action events\n├── state/          # Current face state\n└── history/        # Historical data\n\nservo/\n├── command/        # Control commands (PC → ESP8266)\n├── state/          # Current servo state (ESP8266 → PC)\n└── feedback/       # Status feedback\n\nsystem/\n├── status/         # System status\n├── command/        # System commands\n└── logs/           # Log messages\n```\n\n## Detailed Topic Specifications\n\n### Face Topics\n\n#### 1. `face/actions`\n\n**Direction**: PC → MQTT Broker\n**Frequency**: Event-driven (when action detected)\n**Payload Format**: JSON\n\n```json\n{\n  \"timestamp\": \"2026-02-13T10:51:23.230000\",\n  \"action\": \"LOCK_START | LOCK_RELEASE | BLINK | EXPRESSION | MOVE\",\n  \"description\": \"Human-readable description\",\n  \"data\": {\n    \"face_name\": \"Oreste\",\n    \"confidence\": 0.95,\n    \"direction\": \"Left|Right|Up|Down\"\n  }\n}\n```\n\n**Action Types**:\n- `LOCK_START`: Face locked for tracking started\n- `LOCK_RELEASE`: Face lost, lock released\n- `BLINK`: Eye blink detected\n- `EXPRESSION`: Smile/Laugh detected\n- `MOVE`: Face movement detected\n\n**Examples**:\n\n```json\n{\n  \"timestamp\": \"2026-02-13T10:51:23.230Z\",\n  \"action\": \"LOCK_START\",\n  \"description\": \"System locked onto Oreste\",\n  \"data\": {\n    \"face_name\": \"Oreste\",\n    \"confidence\": 0.92\n  }\n}\n```\n\n```json\n{\n  \"timestamp\": \"2026-02-13T10:51:28.628Z\",\n  \"action\": \"BLINK\",\n  \"description\": \"Eye blink detected\",\n  \"data\": {\n    \"face_name\": \"Oreste\",\n    \"blink_duration_ms\": 150\n  }\n}\n```\n\n#### 2. `face/state`\n\n**Direction**: PC → MQTT Broker\n**Frequency**: Every 1-2 seconds (when face locked)\n**Payload Format**: JSON\n\n```json\n{\n  \"timestamp\": \"2026-02-13T10:51:23.230Z\",\n  \"face_name\": \"Oreste\",\n  \"is_locked\": true,\n  \"face_position\": 0.65,\n  \"confidence\": 0.92\n}\n```\n\n**Fields**:\n- `face_name` (string): Name of recognized person\n- `is_locked` (boolean): Whether face is currently tracked\n- `face_position` (float): 0.0 (left) to 1.0 (right)\n- `confidence` (float): Recognition confidence 0.0-1.0\n\n### Servo Topics\n\n#### 1. `servo/command`\n\n**Direction**: PC/Remote → MQTT Broker\n**Frequency**: On demand (when servo should move)\n**Payload Format**: Integer (0-180)\n\n```\n90              # Center position\n45              # Far left\n135             # Far right\n```\n\n**Examples**:\n\n```bash\n# Track face at left side\nmosquitto_pub -t servo/command -m \"45\"\n\n# Center servo\nmosquitto_pub -t servo/command -m \"90\"\n\n# Track face at right side\nmosquitto_pub -t servo/command -m \"135\"\n```\n\n**Angle Mapping**:\n- 0° = Full left\n- 45° = Left\n- 90° = Center\n- 135° = Right\n- 180° = Full right\n\n#### 2. `servo/state`\n\n**Direction**: ESP8266 → MQTT Broker\n**Frequency**: Every 5 seconds or on command\n**Payload Format**: JSON\n\n```json\n{\n  \"current\": 90,\n  \"target\": 90,\n  \"timestamp\": 1234567890\n}\n```\n\n**Fields**:\n- `current` (integer): Current servo angle\n- `target` (integer): Target servo angle\n- `timestamp` (integer): Milliseconds since boot\n\n### System Topics\n\n#### 1. `system/status`\n\n**Direction**: ESP8266 → MQTT Broker\n**Frequency**: Every 5 seconds or on state change\n**Payload Format**: JSON\n**Retain**: Yes (broker retains last message)\n\n```json\n{\n  \"status\": \"online | offline | error\",\n  \"ip\": \"192.168.1.100\",\n  \"servo_angle\": 90,\n  \"uptime_seconds\": 3600\n}\n```\n\n**Status Values**:\n- `online`: ESP8266 connected and operational\n- `offline`: ESP8266 disconnected (retained by broker)\n- `error`: System error detected\n\n## Communication Workflow\n\n### Face Recognition & Tracking Flow\n\n```\n1. PC detects face\n   → Publishes to: face/actions (action: LOCK_START)\n   \n2. Face locked and being tracked\n   → Publishes to: face/state (position: 0.65, is_locked: true)\n   \n3. PC calculates servo angle from face position\n   → Publishes to: servo/command (angle: 120)\n   \n4. ESP8266 receives servo command\n   → Moves servo to angle 120\n   → Publishes to: servo/state (current: 90, target: 120)\n   \n5. Action detected (e.g., blink)\n   → PC publishes to: face/actions (action: BLINK)\n```\n\n### MQTT Message Flow Diagram\n\n```\nPC Vision System                   MQTT Broker                  ESP8266\n├─ Detect face ─────────────────► face/actions LOCK_START\n│\n├─ Track position ────────────────► face/state (pos: 0.65)\n│\n├─ Calculate servo angle ─────────► servo/command (90°)\n│                                      │\n│                                      └──→ [ESP8266 receives]\n│                                      ─────► servo/state (current: 90)\n│\n└─ Detect blink ──────────────────► face/actions BLINK\n```\n\n## QoS (Quality of Service) Levels\n\n- `QoS 0`: Fire and forget (used for state updates)\n- `QoS 1`: At least once (used for control commands)\n- `QoS 2`: Exactly once (not used to minimize latency)\n\n**Default**: Commands use QoS 1, State updates use QoS 1\n\n## Data Types and Validation\n\n### Integer Fields\n\n```python\n# Servo angles (0-180)\nangle: int\nassert 0 <= angle <= 180\n\n# Confidence scores (0.0-1.0)\nconfidence: float\nassert 0.0 <= confidence <= 1.0\n\n# Face position (0.0-1.0)\nface_position: float\nassert 0.0 <= face_position <= 1.0\n```\n\n### Timestamp Format\n\n```python\n# ISO 8601 format with microseconds\nISO_FORMAT = \"%Y-%m-%dT%H:%M:%S.%f\"\n# Example: \"2026-02-13T10:51:23.230000\"\n\n# Alternative: Unix timestamp\nUNIX_TIMESTAMP = 1234567890.123\n```\n\n## Error Handling\n\n### Invalid Command\n\n```json\n{\n  \"error\": \"Invalid angle: 250. Expected 0-180\",\n  \"topic\": \"servo/command\",\n  \"payload\": \"250\"\n}\n```\n\n### Connection Loss\n\n```\nPC loses MQTT → Retries with exponential backoff\nESP8266 loses WiFi → Will message triggers\nBroker sends last will: system/status = \"offline\"\n```\n\n## Monitoring and Debugging\n\n### Subscribe to All Messages\n\n```bash\nmosquitto_sub -v -h localhost -t '#'\n```\n\n### Monitor Specific Topics\n\n```bash\n# Face actions\nmosquitto_sub -h localhost -t \"face/actions\"\n\n# Servo state\nmosquitto_sub -h localhost -t \"servo/state\"\n\n# System status\nmosquitto_sub -h localhost -t \"system/status\"\n```\n\n### Publish Test Messages\n\n```bash\n# Test servo angle\nmosquitto_pub -h localhost -t \"servo/command\" -m \"45\"\n\n# Simulate face action\nmosquitto_pub -h localhost -t \"face/actions\" -m \\\n  '{\"timestamp\": \"2026-02-13T10:51:23Z\", \"action\": \"BLINK\"}'\n```\n\n## Performance Specifications\n\n| Parameter | Value | Notes |\n|-----------|-------|-------|\n| Message Latency | < 100 ms | Command to servo movement |\n| State Update Frequency | 1-2 Hz | Face position updates |\n| Action Detection Frequency | On-demand | ~100 Hz video |\n| Servo Command Rate | 20 Hz max | Rate limiting to prevent servo jitter |\n| Message Size (typical) | 200-500 bytes | JSON payloads |\n| Broker Buffer | Unlimited | Publish/Subscribe buffering |\n\n## Security Considerations\n\n### For Production Deployment\n\n1. **Enable Authentication**\n   ```python\n   mqtt_manager = MQTTManager(\n       broker=\"broker.example.com\",\n       port=8883,  # TLS port\n       username=\"face_system\",\n       password=\"secure_password\"\n   )\n   ```\n\n2. **Use TLS/SSL**\n   - Port 1883: Unencrypted (localhost only)\n   - Port 8883: TLS encrypted (external networks)\n\n3. **Topic Access Control**\n   ```\n   PC:        Can publish to face/*, servo/command\n   ESP8266:   Can publish to servo/state, system/status\n   Web UI:    Can subscribe to face/*, servo/state, system/status\n   ```\n\n4. **Message Retention**\n   - Enable only for: `system/status`\n   - Disable for: `face/actions`, `servo/command`\n\n## Troubleshooting\n\n### Messages Not Received\n\n```bash\n# Check MQTT broker connectivity\nmosquitto_pub -h localhost -t \"test\" -m \"hello\"\nmosquitto_sub -h localhost -t \"test\"\n\n# Verify topic names (case-sensitive)\nmosquitto_sub -v -h localhost -t \"#\"  # Subscribe to all\n```\n\n### High Latency\n\n```\nPossible causes:\n1. Network congestion → Reduce publish frequency\n2. Broker overload → Check broker logs\n3. WiFi signal weak → Move ESP8266 closer to router\n4. QoS 2 usage → Switch to QoS 1\n```\n\n### ESP8266 Disconnects\n\n```\nSolutions:\n1. Check WiFi credentials\n2. Verify broker IP/port accessible from ESP8266\n3. Check MQTT username/password if enabled\n4. Monitor serial console for error messages\n5. Add WiFi reconnection logic (already in firmware)\n```\n\n## References\n\n- MQTT Specification: https://mqtt.org/mqtt-specification\n- Mosquitto Documentation: https://mosquitto.org/documentation/\n- PubSubClient GitHub: https://github.com/knolleary/pubsubclient\n- JSON Schema: https://json-schema.org/\n